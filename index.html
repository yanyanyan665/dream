<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dream - ç¤¾äº¤å¹³å°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #f5f5f5;
            --text-color: #333333;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --hover-color: #f0f0f0;
            --bg-image: none;
            /* é»˜è®¤é®ç½©æµ“åº¦å˜é‡ */
            --overlay-opacity: 0.5;
            --bg-overlay-color: 255, 255, 255;
            --global-scale: 0.92;
            --admin-color: #666666;
            --announcement-color: #f9f9f9;
            --pinned-color: #f0f0f0;
            --delete-color: #444444;
            --gray-light: #f5f5f5;
            --gray-medium: #999999;
            --gray-dark: #666666;
            --dark-bg: #1a1a1a;
            --dark-card: #2d2d2d;
            --dark-text: #e0e0e0;
            --dark-border: #444444;
            --chat-bg: transparent;
            --custom-font: inherit;
            --chat-bubble-color: #ffffff;
            --special-avatar-bg: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
            font-size: calc(14px * var(--global-scale));
            font-family: var(--custom-font), 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        input, .editor-content {
            user-select: text;
        }

        body {
            font-family: var(--custom-font), 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--secondary-color);
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-color);
            line-height: 1.5;
            padding-bottom: 50px;
            min-height: 100vh;
            position: relative;
        }
        
        /* èƒŒæ™¯é®ç½©å±‚ */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(var(--bg-overlay-color), var(--overlay-opacity));
            z-index: -1;
            pointer-events: none;
            transition: background-color 0.3s ease;
        }

        .post-content, .comment-content, .message-text, .profile-bio, .post-author, .comment-author, .message-sender {
            filter: grayscale(100%);
        }

        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
            --secondary-color: var(--dark-bg);
            --card-bg: var(--dark-card);
            --text-color: var(--dark-text);
            --border-color: var(--dark-border);
            --hover-color: #3a3a3a;
            --announcement-color: #3a3a3a;
            --pinned-color: #3a3a3a;
            --gray-light: #3a3a3a;
--chat-bubble-color: var(--dark-card);
            --bg-overlay-color: 0, 0, 0;
            --special-avatar-bg: #000000;
        }

        body.post-detail-page {
            padding-bottom: 0;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 12px;
        }

        header {
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 12px 0;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
            border-radius: 0 0 12px 12px;
            padding-left: 15px;
padding-right: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 18px;
        }

        .logo i {
            font-size: 20px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .header-action {
            cursor: pointer;
            color: var(--text-color);
        }

        .back-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 15px;
            display: none;
            position: fixed;
            top: 10px;
            left: 15px;
            z-index: 101;
        }
        
        #post-detail-page .back-button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .page {
            display: none;
            margin-bottom: 15px;
        }

        .page.active {
            display: block;
        }

        #post-detail-page.active {
            margin-bottom: 0;
            padding-top: 40px;
            padding-bottom: 90px; 
        }

        .btn {
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 15px;
        }

        .btn:hover { opacity: 0.9; }
        .btn-block { width: 100%; }
        .btn-gray { background-color: var(--gray-dark); color: white; }
        .btn-admin { background-color: var(--admin-color); color: white; }
        .btn-outline { background-color: transparent; border: 1px solid var(--primary-color); color: var(--text-color); }

        .form-group {
            display: grid;
            gap: 6px;
            margin-bottom: 15px;
        }
        
        .form-group input {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 15px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        /* æ»‘åŠ¨æ¡æ ·å¼ */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            margin: 10px 0;
            background: transparent;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: var(--gray-medium);
            border-radius: 3px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -7px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .post {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .post.pinned {
            background-color: var(--pinned-color);
            border-left: 4px solid var(--gray-dark);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .post-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            background-color: var(--gray-light);
            border: 1px solid var(--border-color);
}
        
        .post-avatar.special-avatar {
            background-color: var(--special-avatar-bg) !important;
            border: 1px solid var(--border-color);
        }

        .post-meta { flex-grow: 1; }
        .post-author { font-weight: 600; font-size: 14px; }
        .post-time { font-size: 12px; color: var(--gray-medium); }
        .post-uid { font-size: 11px; color: var(--gray-medium); cursor: pointer; }
        
        .post-footer-content { margin-bottom: 10px; display: flex; align-items: center; flex-wrap: wrap; gap: 8px; }
        .post-location {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: var(--gray-dark);
            background-color: var(--hover-color);
            padding: 4px 8px;
            border-radius: 12px;
            width: fit-content;
            line-height: 1;
        }
        .post-location i { font-size: 11px; color: var(--gray-medium); }
.post-collection-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-color);
            background-color: rgba(0,0,0,0.04);
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }
body.dark-mode .post-collection-tag {
            background-color: rgba(255,255,255,0.08); 
        }

        .post-content { margin-bottom: 12px; font-size: 14px; line-height: 1.6; }

        .post-images { display: grid; gap: 5px; margin-bottom: 12px; }
        .post-images.single { grid-template-columns: 1fr; }
        .post-images.double { grid-template-columns: 1fr 1fr; }
        .post-images.triple { grid-template-columns: repeat(3, 1fr); }
        .post-images.multiple { grid-template-columns: repeat(3, 1fr); }
        .post-image { width: 100%; object-fit: cover; cursor: pointer; background-color: var(--gray-light); border-radius: 8px; }
        .post-image.large { aspect-ratio: 16/9; }
        .post-image.small { aspect-ratio: 1; }

        .post-actions {
            display: flex; gap: 15px; font-size: 13px; color: var(--gray-medium);
            border-top: 1px solid var(--border-color); padding-top: 12px;
        }
        .post-action { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .post-action.active { color: var(--primary-color); }
        .post-admin-actions { display: flex; gap: 5px; margin-top: 10px; justify-content: flex-end; flex-wrap: wrap; }
        .admin-btn { background-color: var(--gray-dark); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px; }
        .admin-badge { background-color: var(--admin-color); color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 8px; }

        /* èŠå¤©å®¤æ ·å¼ */
        .chat-container { display: grid; grid-template-rows: auto 1fr auto; height: calc(100vh - 180px); background-color: var(--chat-bg); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .chat-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--card-bg); }
        .chat-messages { padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background-color: rgba(255,255,255,0.05); }
.message { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 13px; display: flex; align-items: flex-start; gap: 6px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message.incoming { background-color: var(--chat-bubble-color); align-self: flex-start; border: 1px solid var(--border-color); border-top-left-radius: 2px; }
        .message.outgoing { background-color: var(--chat-bubble-color); color: var(--text-color); align-self: flex-end; flex-direction: row-reverse; border: 1px solid var(--border-color); border-top-right-radius: 2px; }
        .message-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 1px solid var(--border-color); }
        .message-content { flex-grow: 1; min-width: 0; }
        .message-sender { font-weight: 700; font-size: 11px; margin-bottom: 2px; opacity: 0.7; }
        .message-text { font-size: 14px; word-break: break-all; white-space: pre-wrap; }
        .message-img { max-width: 100%; max-height: 200px; border-radius: 6px; margin-top: 4px; display: block; cursor: pointer; object-fit: cover; border: 1px solid var(--border-color); }
        
        /* å¼•ç”¨æ ·å¼ */
        .message-quote { background-color: var(--gray-light); border-left: 3px solid var(--gray-dark); padding: 4px 8px; margin-bottom: 6px; border-radius: 4px; font-size: 11px; color: var(--gray-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .chat-input-container { background-color: var(--card-bg); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .chat-quote-preview { display: none; padding: 8px 15px; background-color: var(--hover-color); border-bottom: 1px solid var(--border-color); font-size: 12px; color: var(--gray-dark); justify-content: space-between; align-items: center; }
        .chat-input { padding: 10px 15px 15px 15px; display: flex; gap: 10px; align-items: center; }
        .chat-input input { flex-grow: 1; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 20px; outline: none; font-size: 14px; background-color: var(--gray-light); color: var(--text-color); }

        /* æ¶ˆæ¯ä¸Šä¸‹æ–‡èœå• */
        .message-context-menu { display: none; position: absolute; background: var(--card-bg); border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 8px; z-index: 1005; min-width: 100px; overflow: hidden; }
        .message-context-item { padding: 10px 15px; font-size: 13px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .message-context-item:last-child { border-bottom: none; }
        .message-context-item:hover { background-color: var(--hover-color); }

        /* å‘å¸ƒè¡¨å• */
        .publish-form { background-color: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); max-width: 500px; margin: 0 auto; }
        .editor-toolbar { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; padding: 8px; background-color: var(--gray-light); border-radius: 8px; }
        .editor-toolbar button, .editor-toolbar select { padding: 6px 8px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-color); cursor: pointer; }
        .publish-form .editor-content { width: 100%; min-height: 150px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; resize: vertical; font-family: inherit; font-size: 15px; outline: none; background-color: var(--card-bg); color: var(--text-color); }
        .image-preview { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 15px; }
        .image-preview-item { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; background-color: var(--gray-light); }
        .image-preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .image-preview-item .remove-image { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; }
        .image-layout-selector { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .layout-option { padding: 8px 12px; background-color: var(--gray-light); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 12px; }
        .layout-option.active { background-color: var(--primary-color); color: white; }

        /* åˆé›†å¯¼èˆªæ æ ·å¼ */
        .collections-bar { display: flex; gap: 8px; overflow-x: auto; padding: 10px 5px; margin-bottom: 10px; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .collections-bar::-webkit-scrollbar { display: none; }
        .collection-chip { padding: 6px 14px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 20px; font-size: 13px; color: var(--gray-dark); cursor: pointer; flex-shrink: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .collection-chip.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        /* === æ–°å¢ï¼šæœç´¢æ¡†æ ·å¼ === */
        #explore-search-container {
            display: flex;
            align-items: center;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 5px 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        #explore-search-container i { color: var(--gray-medium); margin-right: 8px; }
        #explore-search-input { border: none; background: transparent; width: 100%; padding: 8px 0; outline: none; font-size: 14px; color: var(--text-color); }
        /* === ç»“æŸ === */
        
        /* ä¸ªäººä¸­å¿ƒ */
        .profile-card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); text-align: center; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); margin: 0 auto 15px; background-color: var(--gray-light); }
        .profile-name { font-weight: 700; font-size: 18px; margin-bottom: 5px; }
        .profile-stats { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; }
        .stat { text-align: center; cursor: pointer; }
        .stat-value { font-weight: 700; font-size: 16px; }
        .profile-form { background-color: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px; display: grid; gap: 15px; border: 1px solid var(--border-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .avatar-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); background-color: var(--gray-light); }

        /* åº•éƒ¨å¯¼èˆª */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--card-bg); display: flex; justify-content: space-around; padding: 8px 0; border-top: 1px solid var(--border-color); z-index: 1000; box-shadow: 0 -1px 5px rgba(0,0,0,0.05); }
        #post-detail-page .bottom-nav { display: none !important; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; gap: 3px; cursor: pointer; padding: 5px 10px; border-radius: 8px; font-size: 11px; color: var(--gray-medium); }
        .nav-btn.active { color: var(--primary-color); }
        .nav-btn i { font-size: 18px; }

        /* è¯„è®ºæ ·å¼æ›´æ–° */
        .comment { padding: 12px; margin-bottom: 10px; margin-left: 15px; background-color: var(--card-bg); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
        .comment-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .comment-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; background-color: var(--gray-light); border: 1px solid var(--border-color); }
        .comment-form { display: flex; align-items: center; gap: 10px; position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--card-bg); padding: 10px 15px; border-top: 1px solid var(--border-color); z-index: 1002; padding-bottom: calc(10px + env(safe-area-inset-bottom)); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        @media (min-width: 600px) { .comment-form { left: 50%; transform: translateX(-50%); max-width: 600px; border-radius: 12px 12px 0 0; } }
        .comment-form input { flex-grow: 1; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 20px; outline: none; background-color: var(--gray-light); color: var(--text-color); }
        .tab-view { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .tab { padding: 8px 15px; cursor: pointer; font-size: 14px; color: var(--gray-medium); }
        .tab.active { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); }
        
        .empty-state { text-align: center; padding: 40px 20px; color: var(--gray-medium); display: flex; flex-direction: column; align-items: center; }
        .empty-state i { font-size: 40px; margin-bottom: 15px; opacity: 0.5; }
        .post-detail { background-color: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .post-detail.no-border { box-shadow: none; border: none; padding: 0; background-color: transparent; }
        .comments-section { margin-top: 20px; padding-bottom: 20px; }

        /* å›¾ç‰‡æŸ¥çœ‹å™¨ */
        .image-viewer { display: none; position: fixed; z-index: 1001; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.95); justify-content: center; align-items: center; }
        .image-viewer-content { max-width: 95%; max-height: 90%; }
        .image-viewer-content img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .image-viewer-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.3); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .image-viewer-nav { position: absolute; top: 50%; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; transform: translateY(-50%); }
        .image-viewer-nav button { background-color: rgba(255, 255, 255, 0.3); border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; color: white; }

        /* è®¾ç½®é¡µé¢ */
        .settings-form { background-color: var(--card-bg); border-radius: 12px; padding: 20px; display: grid; gap: 15px; border: 1px solid var(--border-color); }
        .settings-option { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .mode-switch { position: relative; display: inline-block; width: 60px; height: 30px; }
        .mode-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--gray-medium); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(30px); }

        /* æ¢¦å¢ƒç”µå° */
        .dream-radio { position: fixed; bottom: 80px; right: 20px; width: 50px; height: 50px; background-color: var(--card-bg); border: 2px solid var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 900; cursor: grab; touch-action: none; user-select: none; transition: transform 0.2s; }
        .dream-radio:active { cursor: grabbing; transform: scale(0.95); }
        .dream-radio.hidden { display: none; }
        .dream-radio.force-hidden { display: none !important; }
        .music-bars { display: flex; align-items: flex-end; justify-content: center; gap: 3px; height: 30px; width: 30px; }
        .music-bar { width: 4px; background-color: var(--gray-dark); animation: music-bounce 1s infinite; border-radius: 2px; }
        .music-bar:nth-child(1) { animation-delay: 0s; } .music-bar:nth-child(2) { animation-delay: 0.2s; } .music-bar:nth-child(3) { animation-delay: 0.4s; }
        .playing .music-bar { animation-play-state: running; } .paused .music-bar { animation-play-state: paused; height: 4px; }
        @keyframes music-bounce { 0%, 100% { height: 4px; } 50% { height: 25px; } }
        .sound-menu { display: none; position: fixed; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 901; min-width: 120px; }
        .sound-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); font-size: 12px; }
        .sound-item:last-child { border-bottom: none; }
        .sound-item:hover { background-color: var(--hover-color); }
        .sound-item.active { color: var(--primary-color); font-weight: bold; }
        
        .radio-hidden-trigger { position: fixed; bottom: 0; left: 0; width: 100%; height: 30px; z-index: 9999; display: none; }
        .radio-hidden-trigger.force-hidden { display: none !important; }
        
        .draft-item { background-color: var(--card-bg); border-radius: 8px; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .draft-actions button { padding: 4px 8px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        .draft-resume { background-color: var(--primary-color); color: white; }
        .draft-delete { background-color: #d9534f; color: white; }
        
        /* ç®¡ç†å‘˜å¼¹çª— */
        .admin-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .admin-modal-content { background-color: var(--card-bg); margin: 15% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; border: 1px solid var(--border-color); }
        
        /* === æ–°å¢ï¼šè´¦å·åˆ‡æ¢å¼¹çª—æ ·å¼ === */
        #account-modal .account-list { max-height: 200px; overflow-y: auto; margin-bottom: 15px; }
        #account-modal .account-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        #account-modal .account-item:hover { background-color: var(--hover-color); }
        #account-modal .account-item.active { background-color: rgba(0,0,0,0.05); }
        body.dark-mode #account-modal .account-item.active { background-color: rgba(255,255,255,0.05); }
        #account-modal .account-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        #account-modal .account-info { flex-grow: 1; }
        #account-modal .account-name { font-weight: bold; font-size: 14px; }
        #account-modal .account-uid { font-size: 11px; color: var(--gray-medium); }
        #account-modal .account-action { color: var(--gray-medium); cursor: pointer; }
        #account-modal .account-action:hover { color: var(--delete-color); }
        /* === ç»“æŸ === */
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { color: var(--gray-medium); font-size: 28px; cursor: pointer; }

    </style>
</head>
<body>
    <!-- æ¢¦å¢ƒç”µå° -->
    <div class="dream-radio paused" id="dream-radio" title="åŒå‡»éšè—ï¼Œé•¿æŒ‰å³é”®èœå•">
<div class="music-bars paused" id="music-bars">
            <div class="music-bar"></div>
            <div class="music-bar"></div>
            <div class="music-bar"></div>
        </div>
        <audio id="dream-audio" loop preload="auto">
            <source src="https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg" type="audio/ogg">
        </audio>
    </div>
    <div class="radio-hidden-trigger" id="radioTrigger" title="åŒå‡»æ­¤å¤„å”¤é†’ç”µå°"></div>

    <div class="sound-menu" id="sound-menu">
        <div class="sound-item active" data-sound="rain">ğŸŒ§ï¸ é›¨å£°</div>
        <div class="sound-item" data-sound="forest">ğŸŒ² æ£®æ—</div>
        <div class="sound-item" data-sound="beach">ğŸ–ï¸ æµ·æµª</div>
        <div class="sound-item" data-sound="coffee">â˜• å’–å•¡å…</div>
        <div class="sound-item" data-sound="wind">ğŸ’¨ é£å£°</div>
    </div>
    
    <!-- æ¶ˆæ¯å³é”®èœå• -->
    <div class="message-context-menu" id="message-context-menu">
        <div class="message-context-item" id="quote-msg-btn">å¼•ç”¨æ¶ˆæ¯</div>
    </div>

    <!-- ä¸»åº”ç”¨é¡µé¢ -->
    <div class="page active" id="app-page">
        <header>
            <div class="logo">
                <i class="fas fa-moon"></i>
                <span>Dream</span>
</div>
            <div class="header-actions">
                <div class="header-action" id="settings-btn">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="header-action" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
            </div>
        </header>
        
        <div class="container">
            <!-- é¦–é¡µ -->
            <div class="page active" id="home-page">
                <div id="pinned-posts"></div>
                <div id="featured-posts"></div>
            </div>
            
            <!-- å‘ç°é¡µé¢ -->
            <div class="page" id="explore-page">
                <!-- === æ–°å¢ï¼šæœç´¢æ¡† === -->
                <div id="explore-search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="explore-search-input" placeholder="æœç´¢å¸–å­å†…å®¹ã€ä½œè€…...">
                </div>
                <!-- === ç»“æŸ === -->

                <div class="collections-bar" id="collections-nav" style="display:none;">
                    <div class="collection-chip active" data-collection="all">å…¨éƒ¨</div>
                </div>
                
                <div id="explore-posts"></div>
            </div>
            
            <!-- å‘å¸ƒé¡µé¢ -->
            <div class="page" id="publish-page">
                <div class="uid-toggle" style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                    <label for="show-uid">æ˜¾ç¤ºUID:</label>
                    <label class="mode-switch">
                        <input type="checkbox" id="show-uid" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="publish-form">
                    <div class="editor-toolbar">
                        <button type="button" data-command="bold" title="åŠ ç²—"><i class="fas fa-bold"></i></button>
                        <button type="button" data-command="italic" title="æ–œä½“"><i class="fas fa-italic"></i></button>
                        <button type="button" data-command="underline" title="ä¸‹åˆ’çº¿"><i class="fas fa-underline"></i></button>
                        <select id="font-family">
                            <option value="Arial">Arial</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Georgia">Georgia</option>
</select>
                        <select id="font-size">
                            <option value="1">å°</option>
                            <option value="3" selected>ä¸­</option>
                            <option value="5">å¤§</option>
                        </select>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <input type="color" id="text-color" title="æ–‡å­—é¢œè‰²">
                        </div>
                        <button type="button" id="insert-link" title="æ’å…¥é“¾æ¥"><i class="fas fa-link"></i></button>
                        <button type="button" id="location-btn" title="æ·»åŠ ä½ç½®"><i class="fas fa-map-marker-alt"></i></button>
                    </div>
                    
                    <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                         <i class="fas fa-layer-group" style="color:var(--gray-dark); font-size: 14px;"></i>
                         <input type="text" id="collection-input" list="user-collections-list" 
                                placeholder="è¾“å…¥æ–°å»ºæˆ–é€‰æ‹©åˆé›† (å¯é€‰)" 
                                style="flex:1; padding: 8px 10px; border:1px solid var(--border-color); border-radius: 6px; font-size: 13px;">
                         <datalist id="user-collections-list"></datalist>
                    </div>

                    <div class="editor-content" contenteditable="true" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..."></div>
                    
                    <div id="location-display" style="margin-bottom:10px; padding:8px; background-color:var(--gray-light); border-radius:4px; display:none;">
                        <span id="location-text"></span>
                        <button type="button" id="remove-location" style="float:right; background:none; border:none; color:var(--gray-medium); cursor:pointer;">âœ•</button>
                    </div>
                    
                    <div class="image-layout-selector">
                        <div class="layout-option active" data-layout="auto">è‡ªåŠ¨å¸ƒå±€</div>
                        <div class="layout-option" data-layout="single-large">å•å¼ å¤§å›¾</div>
                        <div class="layout-option" data-layout="single-small">å•å¼ å°å›¾</div>
                        <div class="layout-option" data-layout="grid">ç½‘æ ¼å¸ƒå±€</div>
                    </div>

                    <div class="image-preview" id="image-preview"></div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <label for="image-upload" class="btn btn-gray">
                            <i class="fas fa-image"></i> æ·»åŠ å›¾ç‰‡
                        </label>
                        <input type="file" id="image-upload" accept="image/*" multiple style="display: none;">
                    </div>
                    
                    <button class="btn btn-block draft-btn btn-outline" id="save-draft-btn" style="margin-bottom:10px;">
                        <i class="fas fa-save"></i> æš‚å­˜è‰ç¨¿
                    </button>
                    <button class="btn btn-block" id="publish-btn">
                        <i class="fas fa-paper-plane"></i> å‘å¸ƒ
                    </button>
                </div>
            </div>
            
            <!-- èŠå¤©é¡µé¢ -->
            <div class="page" id="chat-page">
                <div class="chat-container">
                    <div class="chat-header">
                        <h3>èŠå¤©å®¤</h3>
                        <div>
                            <span id="room-status">æœªè¿æ¥</span>
                            <span class="online-count" id="online-count" style="margin-left:10px; font-size:12px; color:var(--gray-medium);"></span>
                        </div>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <div class="system-message" style="text-align:center; font-size:12px; color:var(--gray-medium); margin:8px 0;">æ¬¢è¿æ¥åˆ°èŠå¤©å®¤</div>
                    </div>

                    <div class="chat-input-container">
                        <div class="chat-quote-preview" id="chat-quote-preview">
                            <span id="quote-text-preview"></span>
                            <i class="fas fa-times" id="cancel-quote" style="cursor:pointer;"></i>
                        </div>
                        <div class="chat-input">
                            <label for="chat-image-input" class="chat-btn-icon">
                                <i class="far fa-image"></i>
                            </label>
                            <input type="file" id="chat-image-input" accept="image/*" style="display:none">
                            <input type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." id="message-input" disabled>
                            <button class="btn" id="send-message" disabled><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <div class="room-join" style="display:flex; gap:10px;">
                        <input type="text" id="room-id" placeholder="è¾“å…¥æˆ¿é—´å·" style="flex-grow:1;">
                        <button class="btn" id="join-room">
                            <i class="fas fa-door-open"></i> åŠ å…¥æˆ¿é—´
                        </button>
                    </div>
                    <button class="btn btn-block" id="leave-room" style="display: none; margin-top: 10px;">
                        <i class="fas fa-door-closed"></i> ç¦»å¼€æˆ¿é—´
                    </button>
                </div>
            </div>
            
            <!-- æˆ‘çš„é¡µé¢ -->
            <div class="page" id="profile-page">
                <div class="profile-card">
                    <img src="" alt="å¤´åƒ" class="profile-avatar" id="profile-avatar">
                    <div class="profile-name" id="profile-name"></div>
                    <div class="profile-uid" id="profile-uid" title="ç‚¹å‡»ä¿®æ”¹"></div>
                    <div class="profile-bio" id="profile-bio"></div>
                    <div class="profile-stats">
                        <div class="stat" id="stat-posts">
                            <div class="stat-value" id="post-count">0</div>
                            <div class="stat-label">å¸–å­</div>
                        </div>
                        <div class="stat" id="stat-followers" title="ç‚¹å‡»ä¿®æ”¹">
                            <div class="stat-value" id="follower-count">0</div>
                            <div class="stat-label">ç²‰ä¸</div>
                        </div>
                        <div class="stat" id="stat-following" title="ç‚¹å‡»ä¿®æ”¹">
                            <div class="stat-value" id="following-count">0</div>
                            <div class="stat-label">å…³æ³¨</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn" id="edit-profile-btn">
                            <i class="fas fa-edit"></i> ç¼–è¾‘èµ„æ–™
                        </button>
                        <button class="btn btn-admin" id="admin-access-btn">
                            <i class="fas fa-shield-alt"></i> ç®¡ç†å‘˜
                        </button>
                    </div>
                </div>
                
                <div class="profile-form" id="edit-profile-form" style="display: none;">
                    <h3>ç¼–è¾‘èµ„æ–™</h3>
                    <div class="avatar-upload">
                        <img src="" alt="å¤´åƒé¢„è§ˆ" class="avatar-preview" id="avatar-preview">
                        <div>
                            <button class="btn" id="upload-avatar-btn">
                                <i class="fas fa-upload"></i> ä¸Šä¼ å¤´åƒ
                            </button>
                            <input type="file" id="avatar-upload" style="display: none;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="profile-name-input">ç”¨æˆ·å</label>
                        <input type="text" id="profile-name-input">
                    </div>
                    <div class="form-group">
                        <label for="profile-bio-input">ä¸ªäººç®€ä»‹</label>
                        <input type="text" id="profile-bio-input">
                    </div>
                    <button class="btn btn-block" id="save-profile-btn">
                        <i class="fas fa-save"></i> ä¿å­˜æ›´æ”¹
                    </button>
                </div>
                
                <div class="tab-view">
                    <div class="tab active" data-tab="my-posts">æˆ‘çš„å¸–å­</div>
                    <div class="tab" data-tab="drafts">è‰ç¨¿ç®±</div>
                    <div class="tab" data-tab="favorites">æ”¶è—å¤¹</div>
                </div>
                
                <div id="user-posts"></div>
                <div id="drafts-container" style="display: none;"></div>
                <div id="favorites-container" style="display: none;"></div>
            </div>
            
            <!-- è®¾ç½®é¡µé¢ -->
            <div class="page" id="settings-page">
                <div class="settings-form">
                    <h3>åº”ç”¨è®¾ç½®</h3>
                    
                    <div class="settings-option">
                        <span>å¤œé—´æ¨¡å¼</span>
                        <label class="mode-switch">
                            <input type="checkbox" id="dark-mode-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <!-- === æ–°å¢ï¼šéšè—æ¢¦å¢ƒç”µå° === -->
                    <div class="settings-option">
                        <span>éšè—æ¢¦å¢ƒç”µå°æ‚¬æµ®çƒ</span>
                        <label class="mode-switch">
                            <input type="checkbox" id="hide-radio-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <!-- === ç»“æŸ === -->

                    <!-- === æ–°å¢ï¼šè´¦å·åˆ‡æ¢å…¥å£ === -->
                    <div class="settings-option" id="account-switch-option" style="cursor: pointer;">
                        <span>åˆ‡æ¢è´¦å· (ç²¾åˆ†æ¨¡å¼)</span>
                        <i class="fas fa-chevron-right" style="color:var(--gray-medium);"></i>
                    </div>
                    <!-- === ç»“æŸ === -->

                    <div class="form-group" style="margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                        <h4>èƒŒæ™¯è®¾ç½®</h4>
                        
                        <div style="margin-top:10px;">
                            <label for="bg-image-input" style="font-size:13px; color:var(--gray-dark);">èƒŒæ™¯å›¾ç‰‡é“¾æ¥</label>
                            <input type="text" id="bg-image-input" placeholder="https://...">
                            <div style="display:flex; gap:10px; margin-top:5px;">
                                 <button class="btn btn-gray" onclick="document.getElementById('bg-file-input').click()" style="flex:1;">
                                    <i class="fas fa-upload"></i> ä¸Šä¼ 
                                 </button>
                                 <button class="btn" id="apply-bg-btn" style="flex:1;">åº”ç”¨</button>
                            </div>
                            <input type="file" id="bg-file-input" accept="image/*" style="display:none;">
                        </div>

                        <div style="margin-top:15px;">
                            <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:5px;">
                                <label>èƒŒæ™¯é®ç½©æµ“åº¦</label>
                                <span id="opacity-val">50%</span>
                            </div>
                            <input type="range" id="bg-opacity-slider" min="0" max="1" step="0.05" value="0.5">
                            <div style="font-size:11px; color:var(--gray-medium);">0%=å®Œå…¨æ¸…æ™°èƒŒæ™¯ï¼Œ100%=çº¯è‰²èƒŒæ™¯</div>
                        </div>
                    </div>
                    
                    <div class="settings-option" style="flex-direction: column; align-items: flex-start; gap:10px; border-top: 1px solid var(--border-color); padding-top:15px; margin-top:0;">
                        <span>æ•°æ®ç®¡ç†</span>
                        <div style="display:flex; gap:10px; width:100%;">
                            <button class="btn btn-admin" id="export-data-btn" style="flex:1;"><i class="fas fa-file-export"></i> å¯¼å‡º</button>
                            <button class="btn btn-admin" id="import-data-btn" style="flex:1;"><i class="fas fa-file-import"></i> å¯¼å…¥</button>
                            <input type="file" id="import-file-input" accept=".json" style="display:none;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="music-url">è‡ªå®šä¹‰éŸ³ä¹é“¾æ¥</label>
                        <input type="text" id="music-url" placeholder="è¾“å…¥éŸ³ä¹URL">
                        <button class="btn" id="apply-music" style="margin-top:5px;">åº”ç”¨</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="admin-code-input">ç®¡ç†ç </label>
                        <input type="password" id="admin-code-input" placeholder="è¾“å…¥ç®¡ç†ç ">
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                        <h4>è‡ªå®šä¹‰ CSS (ç¾åŒ–)</h4>
                        <p style="font-size: 12px; color: var(--gray-medium); margin-bottom: 5px;">åœ¨æ­¤å¤„è¾“å…¥ CSS ä»£ç å¯è¦†ç›–é»˜è®¤æ ·å¼ï¼š</p>
                        <textarea id="custom-css-input" rows="6" placeholder=".post { border-radius: 20px; } body { font-family: 'æ¥·ä½“'; }" style="width: 100%; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; background-color: var(--card-bg); color: var(--text-color); font-family: monospace; resize: vertical;"></textarea>
                    </div>

                    <button class="btn btn-block btn-gray" id="clear-cache-btn" style="margin-top:10px;">
                        <i class="fas fa-trash-alt"></i> æ¸…é™¤ç¼“å­˜
                    </button>
                    
                    <button class="btn btn-block" id="save-settings-btn">
                        <i class="fas fa-save"></i> ä¿å­˜è®¾ç½®
                    </button>
                </div>
            </div>
            
           <!-- å¸–å­è¯¦æƒ…é¡µé¢ -->
            <div class="page" id="post-detail-page">
<button class="back-button" id="back-to-explore">
                    <i class="fas fa-arrow-left"></i> è¿”å›
                </button>
                <div class="post-detail no-border" id="post-detail"></div>
                <div class="comments-section" id="comments-section"></div>
                
                <!-- è¯„è®ºè¾“å…¥æ¡† -->
                <div class="comment-form" id="comment-form-sticky">
                    <input type="text" placeholder="å†™è¯„è®º..." id="comment-input">
                    <button class="btn" id="submit-comment"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨å¯¼èˆª -->
        <div class="bottom-nav">
            <div class="nav-btn active" data-page="home-page">
                <i class="fas fa-home"></i>
                <span>é¦–é¡µ</span>
            </div>
            <div class="nav-btn" data-page="explore-page">
                <i class="fas fa-compass"></i>
                <span>å‘ç°</span>
            </div>
            <div class="nav-btn" data-page="publish-page">
                <i class="fas fa-plus-square"></i>
                <span>å‘å¸ƒ</span>
            </div>
            <div class="nav-btn" data-page="chat-page">
                <i class="fas fa-comments"></i>
                <span>èŠå¤©</span>
            </div>
            <div class="nav-btn" data-page="profile-page">
                <i class="fas fa-user"></i>
                <span>æˆ‘çš„</span>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜è®¤è¯æ¨¡æ€æ¡† -->
    <div id="admin-modal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="modal-header">
                <h3>ç®¡ç†å‘˜è®¤è¯</h3>
                <span class="close" id="close-admin-modal">&times;</span>
            </div>
            <div id="admin-modal-body">
                <div class="form-group">
                    <label for="admin-code">è¯·è¾“å…¥ç®¡ç†ç </label>
                    <input type="password" id="admin-code" placeholder="è¾“å…¥ç®¡ç†ç ">
                </div>
                <button class="btn btn-block" id="verify-admin-btn">è·å¾—ç®¡ç†å‘˜æƒé™</button>
                <button class="btn btn-block btn-gray" id="cancel-admin-btn" style="margin-top:10px; display:none;">å–æ¶ˆç®¡ç†å‘˜æƒé™</button>
            </div>
        </div>
    </div>
    
    <!-- === æ–°å¢ï¼šè´¦å·åˆ‡æ¢æ¨¡æ€æ¡† === -->
    <div id="account-modal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="modal-header">
                <h3>åˆ‡æ¢è´¦å· (ç²¾åˆ†æ¨¡å¼)</h3>
                <span class="close" id="close-account-modal">&times;</span>
            </div>
            <div class="account-list" id="account-list"></div>
            <button class="btn btn-block" id="create-account-btn">
                <i class="fas fa-plus"></i> åˆ›å»ºæ–°è´¦å·
            </button>
        </div>
    </div>
    <!-- === ç»“æŸ === -->

    <!-- å›¾ç‰‡æŸ¥çœ‹å™¨ -->
    <div class="image-viewer" id="image-viewer">
<span class="image-viewer-close" id="image-viewer-close">&times;</span>
        <div class="image-viewer-nav">
            <button id="image-viewer-prev"><i class="fas fa-chevron-left"></i></button>
            <button id="image-viewer-next"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="image-viewer-content">
            <img src="" alt="æŸ¥çœ‹å›¾ç‰‡" id="image-viewer-img">
        </div>
    </div>
    <script>
        // ===== å…¨å±€å˜é‡ =====
        let currentUser = null;
        let allPosts = [];
        try {
            allPosts = JSON.parse(localStorage.getItem('allPosts')) || [];
        } catch(e) {
            console.error("Posts corrupted", e);
            allPosts = [];
        }
        
        let mqttClient = null;
        let currentRoom = null;
        let currentPost = null;
        let selectedImages = [];
        let currentViewingImages = [];
        let currentImageIndex = 0;
        let imageLayout = 'auto';
        let showUid = localStorage.getItem('showUid') !== 'false';
        let currentLocation = '';
        let editingPostId = null;
        let drafts = JSON.parse(localStorage.getItem('drafts')) || [];
        let currentSound = 'rain';
        let presenceInterval = null;
        let lastHeartbeats = {};
        
        // åˆé›†ç›¸å…³å˜é‡
        let currentCollectionFilter = 'all'; 
        let availableCollections = new Set();
        
        // === æ–°å¢/ä¿®æ”¹ï¼šå…¨å±€å˜é‡ ===
        let currentSearchTerm = ''; // å½“å‰æœç´¢å…³é”®è¯
        let hideRadio = localStorage.getItem('hideRadio') === 'true'; // éšè—ç”µå°è®¾ç½®
        let userAccounts = []; // å¤šè´¦å·åˆ—è¡¨
        try {
            userAccounts = JSON.parse(localStorage.getItem('userAccounts')) || [];
        } catch(e) { userAccounts = []; }
        // === ç»“æŸ ===
        
        // èŠå¤©å¼•ç”¨å˜é‡
        let currentQuote = null;
        
        const ADMIN_CODE = 'dream2025';

        const soundUrls = {
            rain: 'https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg',
            forest: 'https://actions.google.com/sounds/v1/nature/forest_birds_ambient.ogg',
            beach: 'https://actions.google.com/sounds/v1/water/waves_crashing_on_beach.ogg',
            coffee: 'https://actions.google.com/sounds/v1/mechanical/coffee_maker.ogg',
            wind: 'https://actions.google.com/sounds/v1/nature/wind_chimes.ogg'
        };

        function initApp() {
            // === æ–°å¢ï¼šå¤šè´¦å·æ•°æ®è¿ç§»ä¸åˆå§‹åŒ– ===
            const savedUser = localStorage.getItem('currentUser');
if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if (!Array.isArray(currentUser.posts)) currentUser.posts = [];
                    // å¦‚æœå½“å‰ç”¨æˆ·ä¸åœ¨è´¦å·åˆ—è¡¨ä¸­ï¼ŒåŠ å…¥åˆ—è¡¨ (æ•°æ®è¿ç§»)
                    if (userAccounts.length === 0) {
                        userAccounts.push(currentUser);
                        localStorage.setItem('userAccounts', JSON.stringify(userAccounts));
                    } else {
                        // ç¡®ä¿å½“å‰ç”¨æˆ·ä¿¡æ¯åŒæ­¥åˆ°åˆ—è¡¨
                        const idx = userAccounts.findIndex(u => u.uid === currentUser.uid);
                        if(idx === -1) {
                            userAccounts.push(currentUser);
                            localStorage.setItem('userAccounts', JSON.stringify(userAccounts));
                        }
                    }
                    showAppPage();
                } catch(e) {
                    localStorage.removeItem('currentUser');
                    createTempUser();
                }
            } else {
                // å¦‚æœæ²¡æœ‰å½“å‰ç”¨æˆ·ä½†æœ‰è´¦å·åˆ—è¡¨ï¼Œè‡ªåŠ¨ç™»å½•ç¬¬ä¸€ä¸ª
                if(userAccounts.length > 0) {
                    currentUser = userAccounts[0];
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showAppPage();
} else {
                    createTempUser();
                }
            }
            // === ç»“æŸ ===
            
            ensureUpdateLog();
            initAudioEngine();
            refreshCollectionsData(); 
            applyRadioVisibility(); // åº”ç”¨éšè—ç”µå°è®¾ç½®
        }
        
        // === æ–°å¢ï¼šåº”ç”¨éšè—ç”µå°è®¾ç½® ===
        function applyRadioVisibility() {
            const radio = document.getElementById('dream-radio');
            const trigger = document.getElementById('radioTrigger');
            if (hideRadio) {
                radio.classList.add('force-hidden');
                trigger.classList.add('force-hidden');
                // å¦‚æœæ­£åœ¨æ’­æ”¾åœæ­¢æ’­æ”¾
                if(document.getElementById('dream-audio')){
                    document.getElementById('dream-audio').pause();
                    updateAudioUI(false);
                }
            } else {
                radio.classList.remove('force-hidden');
                trigger.classList.remove('force-hidden');
            }
        }
        // === ç»“æŸ ===

        function refreshCollectionsData() {
            availableCollections.clear();
            allPosts.forEach(post => {
                if (post.collection && post.collection.trim() !== "") {
                    availableCollections.add(post.collection.trim());
                }
            });
            updateCollectionDatalist();
        }

        function updateCollectionDatalist() {
            const datalist = document.getElementById('user-collections-list');
            datalist.innerHTML = '';
            availableCollections.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                datalist.appendChild(option);
            });
        }
        
        function renderCollectionsNav() {
            const container = document.getElementById('collections-nav');
            if (document.getElementById('explore-page').classList.contains('active')) {
                container.style.display = 'flex';
            } else {
                container.style.display = 'none';
                return;
            }

            container.innerHTML = '';
            const allBtn = document.createElement('div');
            allBtn.className = `collection-chip ${currentCollectionFilter === 'all' ? 'active' : ''}`;
            allBtn.textContent = 'å…¨éƒ¨';
            allBtn.onclick = () => filterByCollection('all');
            container.appendChild(allBtn);

            if (availableCollections.size === 0) return;

            availableCollections.forEach(col => {
                const chip = document.createElement('div');
                chip.className = `collection-chip ${currentCollectionFilter === col ? 'active' : ''}`;
                chip.textContent = col;
                chip.onclick = () => filterByCollection(col);
                container.appendChild(chip);
            });
        }

        window.filterByCollection = function(collectionName) {
            currentCollectionFilter = collectionName;
if (!document.getElementById('explore-page').classList.contains('active')) {
                switchPage('explore-page');
            } else {
                renderCollectionsNav();
                renderExplorePosts();
            }
        };

        function initAudioEngine() {
            const unlockAudio = () => {
                const dreamAudio = document.getElementById('dream-audio');
                if (dreamAudio && !hideRadio) { // åªæœ‰æ²¡éšè—æ—¶æ‰å°è¯•æ’­æ”¾
                    const p = dreamAudio.play();
                    if(p !== undefined) {
                        p.then(() => {
                            if (!document.getElementById('dream-radio').classList.contains('playing')) {
                                dreamAudio.pause();
                            }
                        }).catch(() => {});
                    }
                }
                document.body.removeEventListener('click', unlockAudio);
                document.body.removeEventListener('touchstart', unlockAudio);
            };
            document.body.addEventListener('click', unlockAudio);
            document.body.addEventListener('touchstart', unlockAudio);
        }

        function ensureUpdateLog() {
            const systemId = 999999999;
            const logContent = "1.å‘ç°é¡µæ–°å¢æœç´¢åŠŸèƒ½<br>2.æ”¯æŒå¤šè´¦å·åˆ›å»ºä¸åˆ‡æ¢(ç²¾åˆ†æ¨¡å¼)<br>3.è®¾ç½®æ–°å¢æ°¸ä¹…éšè—ç”µå°å¼€å…³<br>4.ä¼˜åŒ–ä»£ç ç»“æ„";
            const systemPostIndex = allPosts.findIndex(p => p.id === systemId);

            if (systemPostIndex === -1) {
                const systemPost = {
                    id: systemId,
                    author: "è¯…éª¨",
                    authorUid: "DEV",
                    authorId: "system_dev",
                    avatar: "",
                    isAuthorAdmin: true,
                    content: logContent,
                    images: [],
                    location: "Dream System",
                    collection: "æ›´æ–°æ—¥å¿—",
                    time: new Date(),
                    likes: 1234,
                    comments: [],
                    favorites: 0,
                    liked: false,
                    isFeatured: false,
                    isPinned: true
                };
                allPosts.unshift(systemPost);
            } else {
                allPosts[systemPostIndex].content = logContent;
                allPosts[systemPostIndex].collection = "æ›´æ–°æ—¥å¿—";
                allPosts[systemPostIndex].isPinned = true;
            }
        }

        function createTempUser() {
            const tempUid = 'dream_' + Math.random().toString(36).substr(2, 6);
            currentUser = {
                id: Date.now(),
                uid: tempUid,
                name: 'æ¢¦æ—…äºº' + Math.floor(Math.random() * 100),
                bio: 'åœ¨è¿™ä¸ªä¸–ç•Œåšä¸ªå¥½æ¢¦',
                avatar: '',
                location: 'æœªçŸ¥',
                posts: [],
                favorites: [],
                followers: 0,
                following: 0,
                isAdmin: false,
                isTemp: true
            };
            // å°†æ–°ç”¨æˆ·åŠ å…¥è´¦å·åˆ—è¡¨
            userAccounts.push(currentUser);
            localStorage.setItem('userAccounts', JSON.stringify(userAccounts));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showAppPage();
        }

        function showNotice(msg) {
            const notice = document.createElement('div');
            notice.textContent = msg;
            notice.style.cssText = `
                position:fixed; top:20px; left:50%; transform:translateX(-50%);
                background:rgba(0,0,0,0.8); color:#fff; padding:10px 20px; border-radius:4px;
                z-index:9999; font-size:14px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); pointer-events:none;
            `;
            document.body.appendChild(notice);
            setTimeout(() => notice.remove(), 2500);
        }

        // ===== æ¢¦å¢ƒç”µå°é€»è¾‘ =====
        const dreamRadio = document.getElementById('dream-radio');
        const dreamAudio = document.getElementById('dream-audio');
        const musicBars = document.getElementById('music-bars');
        const soundMenu = document.getElementById('sound-menu');
        
        let isDown = false, startX, startY, initLeft, initTop;

        const onDown = (e) => {
            if(e.target.closest('.music-bars') || e.target === dreamRadio) {
                isDown = true;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                startX = clientX; 
                startY = clientY;
                const rect = dreamRadio.getBoundingClientRect();
                initLeft = rect.left; 
                initTop = rect.top;
                dreamRadio.style.transition = 'none';
            }
        };

        const onMove = (e) => {
            if(!isDown) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            e.preventDefault();
            dreamRadio.style.left = (initLeft + clientX - startX) + 'px';
            dreamRadio.style.top = (initTop + clientY - startY) + 'px';
            dreamRadio.style.right = 'auto'; 
            dreamRadio.style.bottom = 'auto';
        };

        const onUp = () => { 
            isDown = false; 
            dreamRadio.style.transition = 'transform 0.2s'; 
        };

        dreamRadio.addEventListener('mousedown', onDown);
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
        dreamRadio.addEventListener('touchstart', onDown);
        document.addEventListener('touchmove', onMove);
        document.addEventListener('touchend', onUp);

        let lastClickTime = 0;
        dreamRadio.addEventListener('click', (e) => {
            if(Math.abs(e.clientX - startX) > 5 || Math.abs(e.clientY - startY) > 5) return;
            const now = Date.now();
            if(now - lastClickTime < 300) { 
                dreamRadio.classList.add('hidden');
                document.getElementById('radioTrigger').style.display = 'block';
            } else {
                toggleAudio();
            }
            lastClickTime = now;
        });
        
        function toggleAudio() {
            if(dreamAudio.paused) {
                const playPromise = dreamAudio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        updateAudioUI(true);
                    }).catch(error => { 
                        console.error(error); 
                        if(!hideRadio) showNotice("æ’­æ”¾è¢«æ‹¦æˆªï¼Œè¯·å…ˆç‚¹å‡»ä¸€ä¸‹é¡µé¢å…¶ä»–ä½ç½®"); 
                    });
                }
            } else {
                dreamAudio.pause();
                updateAudioUI(false);
            }
        }
        
        function updateAudioUI(isPlaying) {
            if(isPlaying) {
                dreamRadio.classList.remove('paused');
                dreamRadio.classList.add('playing');
                musicBars.classList.remove('paused');
                musicBars.classList.add('playing');
            } else {
                dreamRadio.classList.add('paused');
                dreamRadio.classList.remove('playing');
                musicBars.classList.add('paused');
                musicBars.classList.remove('playing');
            }
        }

        document.getElementById('radioTrigger').addEventListener('dblclick', () => {
            if(hideRadio) return; 
            dreamRadio.classList.remove('hidden');
            dreamRadio.style.bottom = '80px';
            dreamRadio.style.right = '20px';
            dreamRadio.style.left = 'auto';
            dreamRadio.style.top = 'auto';
            document.getElementById('radioTrigger').style.display = 'none';
        });

        dreamRadio.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            soundMenu.style.display = 'block';
            soundMenu.style.left = e.clientX + 'px';
            soundMenu.style.top = e.clientY + 'px';
        });

        document.addEventListener('click', (e) => {
            if (!dreamRadio.contains(e.target) && !soundMenu.contains(e.target)) {
                soundMenu.style.display = 'none';
            }
            if (e.target.closest('.message-context-menu') === null) {
                document.getElementById('message-context-menu').style.display = 'none';
}
        });

        document.querySelectorAll('.sound-item').forEach(item => {
            item.addEventListener('click', function() {
                const sound = this.dataset.sound;
                currentSound = sound;
                document.querySelectorAll('.sound-item').forEach(s => s.classList.remove('active'));
                this.classList.add('active');
                dreamAudio.src = soundUrls[sound];
                localStorage.setItem('currentSound', sound);
                if (document.getElementById('dream-radio').classList.contains('playing')) {
                     dreamAudio.play().catch(()=>{});
                }
                showNotice('å£°éŸ³å·²åˆ‡æ¢');
                soundMenu.style.display = 'none';
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            initSettings();
            
            // --- æœç´¢åŠŸèƒ½äº‹ä»¶ ---
            document.getElementById('explore-search-input').addEventListener('input', function(e) {
                currentSearchTerm = e.target.value.toLowerCase().trim();
                renderExplorePosts();
            });
            // --- ç»“æŸ ---

            // --- éšè—ç”µå°è®¾ç½®äº‹ä»¶ ---
            document.getElementById('hide-radio-toggle').addEventListener('change', function() {
                hideRadio = this.checked;
                localStorage.setItem('hideRadio', hideRadio);
                applyRadioVisibility();
            });
            // --- ç»“æŸ ---

            // --- è´¦å·åˆ‡æ¢äº‹ä»¶ç»‘å®š ---
            document.getElementById('account-switch-option').addEventListener('click', function() {
                document.getElementById('account-modal').style.display = 'block';
                renderAccountList();
            });
            document.getElementById('close-account-modal').addEventListener('click', function() {
                document.getElementById('account-modal').style.display = 'none';
            });
            document.getElementById('create-account-btn').addEventListener('click', createTempUser); // åˆ›å»ºæ–°å·é€»è¾‘
            // --- ç»“æŸ ---

            document.getElementById('export-data-btn').addEventListener('click', exportData);
            document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
            document.getElementById('import-file-input').addEventListener('change', importData);

            document.getElementById('submit-comment').addEventListener('click', addComment);
            document.getElementById('comment-input').addEventListener('keypress', function(e) { if(e.key === 'Enter') addComment(); });
            document.getElementById('publish-btn').addEventListener('click', publishPost);
            document.getElementById('save-draft-btn').addEventListener('click', saveDraft);
            
            document.getElementById('edit-profile-btn').addEventListener('click', toggleEditProfile);
            document.getElementById('save-profile-btn').addEventListener('click', saveProfile);
            document.getElementById('admin-access-btn').addEventListener('click', () => document.getElementById('admin-modal').style.display = 'block');
            document.getElementById('verify-admin-btn').addEventListener('click', verifyAdmin);
            document.getElementById('cancel-admin-btn').addEventListener('click', cancelAdmin);
            document.getElementById('close-admin-modal').addEventListener('click', () => document.getElementById('admin-modal').style.display = 'none');
            
            document.getElementById('settings-btn').addEventListener('click', () => switchPage('settings-page'));
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
            
            document.getElementById('apply-music').addEventListener('click', function() {
                const url = document.getElementById('music-url').value.trim();
                if(url) {
                    dreamAudio.src = url;
                    localStorage.setItem('customMusicUrl', url);
                    showNotice('éŸ³ä¹å·²æ›´æ–°');
                }
            });
            document.getElementById('clear-cache-btn').addEventListener('click', function() {
                if(confirm("ç¡®å®šè¦æ¸…é™¤ç¼“å­˜å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†ä¸¢å¤±ï¼")) {
                    localStorage.clear();
                    location.reload();
                }
            });
            
            document.getElementById('apply-bg-btn').addEventListener('click', function() {
                const url = document.getElementById('bg-image-input').value.trim();
                if(url) applyBackground(url);
                else applyBackground('none');
            });
            document.getElementById('bg-file-input').addEventListener('change', function(e) {
                if(e.target.files && e.target.files[0]) {
                    handleImageUpload(e.target.files[0], (base64) => {
                        applyBackground(base64);
                    });
                }
            });
            document.getElementById('bg-opacity-slider').addEventListener('input', function() {
                const val = this.value;
                document.getElementById('opacity-val').textContent = Math.round(val * 100) + '%';
                document.documentElement.style.setProperty('--overlay-opacity', val);
            });
            document.getElementById('bg-opacity-slider').addEventListener('change', function() {
                localStorage.setItem('bgOverlayOpacity', this.value);
            });
            
            document.getElementById('back-to-explore').addEventListener('click', function() {
                switchPage('explore-page');
            });

            document.getElementById('upload-avatar-btn').addEventListener('click', () => document.getElementById('avatar-upload').click());
            document.getElementById('avatar-upload').addEventListener('change', function(e) {
                handleImageUpload(e.target.files[0], (src) => document.getElementById('avatar-preview').src = src);
            });
            
            document.getElementById('image-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    Array.from(e.target.files).forEach(file => {
                        handleImageUpload(file, (src) => {
                            selectedImages.push({ src, layout: imageLayout });
                            renderImagePreview();
                        });
                    });
                }
            });
            
            document.querySelectorAll('.layout-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.layout-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    imageLayout = this.dataset.layout;
                    selectedImages.forEach(img => img.layout = imageLayout);
                    renderImagePreview();
                });
            });
            
            document.getElementById('location-btn').addEventListener('click', function() {
                const loc = prompt('è¾“å…¥ä½ç½®ä¿¡æ¯:');
                if(loc) {
                    currentLocation = loc;
                    document.getElementById('location-display').style.display = 'block';
                    document.getElementById('location-text').innerHTML = '<i class="fas fa-map-marker-alt"></i> ' + loc;
                }
            });
            document.getElementById('remove-location').addEventListener('click', function() {
currentLocation = '';
                document.getElementById('location-display').style.display = 'none';
            });
            
            document.getElementById('join-room').addEventListener('click', joinChatRoom);
            document.getElementById('leave-room').addEventListener('click', leaveChatRoom);
document.getElementById('send-message').addEventListener('click', sendChatMessage);
            document.getElementById('message-input').addEventListener('keypress', function(e) { if (e.key === 'Enter') sendChatMessage(); });
            document.getElementById('chat-image-input').addEventListener('change', function(e) {
                if(e.target.files && e.target.files[0]) {
                    handleImageUpload(e.target.files[0], (base64) => {
                        sendChatImage(base64);
                    }, 400); 
                }
            });
            document.getElementById('cancel-quote').addEventListener('click', cancelQuote);
            document.getElementById('quote-msg-btn').addEventListener('click', function() {
                const author = this.dataset.author;
                const content = this.dataset.content;
                setQuote(author, content);
                document.getElementById('message-context-menu').style.display = 'none';
            });

            document.getElementById('logout-btn').addEventListener('click', logout);

            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const pageId = this.dataset.page;
                    switchPage(pageId);
                    navBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            const profileTabs = document.querySelectorAll('#profile-page .tab');
            profileTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    profileTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('user-posts').style.display = 'none';
                    document.getElementById('drafts-container').style.display = 'none';
                    document.getElementById('favorites-container').style.display = 'none';
                    if (tabName === 'my-posts') {
                        document.getElementById('user-posts').style.display = 'block';
                        renderUserPosts();
                    } else if (tabName === 'drafts') {
                        document.getElementById('drafts-container').style.display = 'block';
                        renderDrafts();
                    } else {
                        document.getElementById('favorites-container').style.display = 'block';
                        renderFavorites();
                    }
                });
            });
            
            document.querySelectorAll('.editor-toolbar button[data-command]').forEach(button => {
                button.addEventListener('click', function() { document.execCommand(this.dataset.command, false, null); });
            });
            document.getElementById('font-family').addEventListener('change', function() { document.execCommand('fontName', false, this.value); });
            document.getElementById('font-size').addEventListener('change', function() { document.execCommand('fontSize', false, this.value); });
            document.getElementById('text-color').addEventListener('input', function() { document.execCommand('foreColor', false, this.value); });
            document.getElementById('insert-link').addEventListener('click', function() {
                const url = prompt('è¾“å…¥é“¾æ¥:', 'https://');
                if (url) document.execCommand('createLink', false, url);
            });
            document.getElementById('image-viewer-close').addEventListener('click', closeImageViewer);
            document.getElementById('image-viewer-prev').addEventListener('click', showPrevImage);
            document.getElementById('image-viewer-next').addEventListener('click', showNextImage);
            
            document.getElementById('show-uid').addEventListener('change', function() {
                showUid = this.checked;
                localStorage.setItem('showUid', showUid);
                renderAllPosts();
            });
            document.getElementById('profile-uid').addEventListener('click', () => {
                const newUid = prompt('è¾“å…¥æ–°UID:', currentUser.uid);
                if(newUid && newUid.trim()) { 
                    currentUser.uid = newUid.trim(); 
                    localStorage.setItem('currentUser', JSON.stringify(currentUser)); 
                    syncCurrentUserToAccounts(); // åŒæ­¥æ›´æ–°
                    updateProfileDisplay(); 
                }
            });
            document.getElementById('stat-followers').addEventListener('click', () => {
                const newVal = prompt('è¾“å…¥ç²‰ä¸æ•°:', currentUser.followers);
                if(newVal && !isNaN(newVal)) { 
                    currentUser.followers = parseInt(newVal); 
                    localStorage.setItem('currentUser', JSON.stringify(currentUser)); 
                    syncCurrentUserToAccounts(); // åŒæ­¥æ›´æ–°
                    updateProfileDisplay(); 
                }
            });
            document.getElementById('stat-following').addEventListener('click', () => {
                const newVal = prompt('è¾“å…¥å…³æ³¨æ•°:', currentUser.following);
                if(newVal && !isNaN(newVal)) { 
                    currentUser.following = parseInt(newVal); 
                    localStorage.setItem('currentUser', JSON.stringify(currentUser)); 
                    syncCurrentUserToAccounts(); // åŒæ­¥æ›´æ–°
                    updateProfileDisplay(); 
                }
            });
            
            window.addEventListener('beforeunload', function() {
                if (mqttClient && currentRoom) {
                    const presenceMsg = JSON.stringify({ uid: currentUser.uid, status: 'leave' });
                    mqttClient.publish(`dream/presence/${currentRoom}`, presenceMsg);
                }
            });
        });

        // === æ–°å¢ï¼šåŒæ­¥å½“å‰ç”¨æˆ·ä¿¡æ¯åˆ°è´¦å·åˆ—è¡¨ ===
        function syncCurrentUserToAccounts() {
            const idx = userAccounts.findIndex(u => u.id === currentUser.id);
            if(idx !== -1) {
                userAccounts[idx] = currentUser;
                localStorage.setItem('userAccounts', JSON.stringify(userAccounts));
            }
        }
        // === ç»“æŸ ===

        // === æ–°å¢ï¼šè´¦å·ç®¡ç†åŠŸèƒ½ ===
        function renderAccountList() {
            const list = document.getElementById('account-list');
            list.innerHTML = '';
            userAccounts.forEach(account => {
                const item = document.createElement('div');
                item.className = `account-item ${account.uid === currentUser.uid ? 'active' : ''}`;
                const avatar = account.avatar || "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
                item.innerHTML = `
                    <img src="${avatar}" class="account-avatar">
                    <div class="account-info">
                        <div class="account-name">${account.name}</div>
                        <div class="account-uid">UID: ${account.uid}</div>
                    </div>
                `;
                if(account.uid !== currentUser.uid || userAccounts.length > 1) { // å¦‚æœæ˜¯å½“å‰å·ä¸”åªæœ‰ä¸€ä¸ªå·ï¼Œä¸æ˜¾ç¤ºåˆ é™¤
                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'account-action';
                    removeBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    removeBtn.title = "ç§»é™¤è´¦å·";
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        // ç§»é™¤è´¦å·é€»è¾‘
                        if(confirm('ç¡®å®šè¦ç§»é™¤è¯¥è´¦å·å—ï¼Ÿ(æ•°æ®ä»ä¿ç•™åœ¨å¸–å­ä¸­)')) {
                            const newAccounts = userAccounts.filter(u => u.uid !== account.uid);
                            userAccounts = newAccounts;
                            localStorage.setItem('userAccounts', JSON.stringify(userAccounts));
                            if(account.uid === currentUser.uid) {
                                // å¦‚æœåˆ çš„æ˜¯å½“å‰å·ï¼Œä¸”è¿˜æœ‰å…¶ä»–å·ï¼Œåˆ‡åˆ°ç¬¬ä¸€ä¸ªï¼Œå¦åˆ™åˆ›å»ºæ–°å·
                                if(userAccounts.length > 0) {
                                    switchAccount(userAccounts[0].uid);
                                } else {
                                    createTempUser();
                                }
                            } else {
                                renderAccountList();
                            }
                        }
                    };
                    item.appendChild(removeBtn);
                }
                
                item.onclick = (e) => {
                    if(e.target.closest('.account-action')) return;
                    if(account.uid !== currentUser.uid) {
                        switchAccount(account.uid);
                    }
                };
                list.appendChild(item);
            });
        }

        function switchAccount(uid) {
            const target = userAccounts.find(u => u.uid === uid);
            if(target) {
                // ä¿å­˜å½“å‰çŠ¶æ€åå†åˆ‡æ¢
                syncCurrentUserToAccounts();
                currentUser = target;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                location.reload(); // åˆ·æ–°ä»¥åº”ç”¨æ–°èº«ä»½
            }
        }
        // === ç»“æŸ ===

        function exportData() {
            refreshCollectionsData();
            const data = {
                version: 1.2, 
                timestamp: new Date().toISOString(),
                currentUser: JSON.parse(localStorage.getItem('currentUser')),
                userAccounts: JSON.parse(localStorage.getItem('userAccounts')), // å¯¼å‡ºå¤šè´¦å·
                allPosts: JSON.parse(localStorage.getItem('allPosts')),
                drafts: JSON.parse(localStorage.getItem('drafts')),
                settings: {
                    darkMode: localStorage.getItem('darkMode'),
                    showUid: localStorage.getItem('showUid'),
                    currentSound: localStorage.getItem('currentSound'),
                    customMusicUrl: localStorage.getItem('customMusicUrl'),
                    bgImage: localStorage.getItem('bgImage'),
                    bgOverlayOpacity: localStorage.getItem('bgOverlayOpacity'),
                    userCustomCSS: localStorage.getItem('userCustomCSS'),
                    hideRadio: localStorage.getItem('hideRadio') // å¯¼å‡ºéšè—è®¾ç½®
                }
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "dream_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showNotice('æ•°æ®å¯¼å‡ºæˆåŠŸ');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.currentUser) localStorage.setItem('currentUser', JSON.stringify(data.currentUser));
                    if (data.userAccounts) localStorage.setItem('userAccounts', JSON.stringify(data.userAccounts));
                    if (data.allPosts) localStorage.setItem('allPosts', JSON.stringify(data.allPosts));
                    if (data.drafts) localStorage.setItem('drafts', JSON.stringify(data.drafts));
                    if (data.settings) {
                        if(data.settings.darkMode) localStorage.setItem('darkMode', data.settings.darkMode);
                        if(data.settings.showUid) localStorage.setItem('showUid', data.settings.showUid);
                        if(data.settings.currentSound) localStorage.setItem('currentSound', data.settings.currentSound);
                        if(data.settings.customMusicUrl) localStorage.setItem('customMusicUrl', data.settings.customMusicUrl);
                        if(data.settings.bgImage) localStorage.setItem('bgImage', data.settings.bgImage);
                        if(data.settings.bgOverlayOpacity) localStorage.setItem('bgOverlayOpacity', data.settings.bgOverlayOpacity);
                        if(data.settings.userCustomCSS) localStorage.setItem('userCustomCSS', data.settings.userCustomCSS);
                        if(data.settings.hideRadio) localStorage.setItem('hideRadio', data.settings.hideRadio);
                    }
                    alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼Œé¡µé¢å°†åˆ·æ–°ã€‚');
                    location.reload();
                } catch (error) {
                    console.error(error);
                    alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
}
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function initSettings() {
            const savedCss = localStorage.getItem('userCustomCSS') || '';
            const cssInput = document.getElementById('custom-css-input');
            if(cssInput) cssInput.value = savedCss;
            applyCustomCSS(savedCss);

            const darkMode = localStorage.getItem('darkMode') === 'true';
            document.getElementById('dark-mode-toggle').checked = darkMode;
            if (darkMode) document.body.classList.add('dark-mode');
            
            // åˆå§‹åŒ–éšè—ç”µå°å¼€å…³çŠ¶æ€
            document.getElementById('hide-radio-toggle').checked = hideRadio;

            const customMusicUrl = localStorage.getItem('customMusicUrl');
            if(customMusicUrl) document.getElementById('music-url').value = customMusicUrl;
            
            const bgImage = localStorage.getItem('bgImage');
            if(bgImage) applyBackground(bgImage, false);
            
            const bgOpacity = localStorage.getItem('bgOverlayOpacity') || '0.5';
            document.documentElement.style.setProperty('--overlay-opacity', bgOpacity);
            document.getElementById('bg-opacity-slider').value = bgOpacity;
            document.getElementById('opacity-val').textContent = Math.round(bgOpacity * 100) + '%';
            
            document.getElementById('dark-mode-toggle').addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('darkMode', 'true');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('darkMode', 'false');
                }
            });
        }

        function applyCustomCSS(cssContent) {
            let styleTag = document.getElementById('user-defined-style');
            if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = 'user-defined-style';
                document.head.appendChild(styleTag);
            }
            styleTag.textContent = cssContent;
        }

        function applyBackground(urlOrBase64, save = true) {
            if (urlOrBase64 === 'none' || !urlOrBase64) {
                document.documentElement.style.setProperty('--bg-image', 'none');
                if(save) localStorage.removeItem('bgImage');
            } else {
                const bgVal = urlOrBase64.startsWith('data:') ? `url(${urlOrBase64})` : `url('${urlOrBase64}')`;
                document.documentElement.style.setProperty('--bg-image', bgVal);
                if(save) localStorage.setItem('bgImage', urlOrBase64);
            }
            if(save) showNotice('èƒŒæ™¯å·²æ›´æ–°');
        }

        // ä¼˜åŒ–å›¾ç‰‡ä¸Šä¼ è´¨é‡ï¼šé»˜è®¤æœ€å¤§å®½åº¦1280ï¼Œè´¨é‡0.9
        function handleImageUpload(file, callback, maxWidth = 1280) {
if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width, height = img.height;
                    const maxH = maxWidth;
                    if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } 
                    else { if (height > maxH) { width *= maxH / height; height = maxH; } }
                    canvas.width = width;
                    canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg', 0.9));
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        function showAppPage() {
            document.getElementById('app-page').classList.add('active');
            updateProfileDisplay();
            renderAllPosts();
        }

        function updateProfileDisplay() {
            if (!currentUser) return;
            document.getElementById('profile-name').textContent = currentUser.name;
            document.getElementById('profile-bio').textContent = currentUser.bio;
            if(currentUser.avatar) document.getElementById('profile-avatar').src = currentUser.avatar;
            document.getElementById('profile-uid').textContent = `UID: ${currentUser.uid}`;
            
            document.getElementById('post-count').textContent = currentUser.posts.length;
            document.getElementById('follower-count').textContent = currentUser.followers;
            document.getElementById('following-count').textContent = currentUser.following;
            
            if (currentUser.isAdmin) {
                document.getElementById('cancel-admin-btn').style.display = 'block';
                document.getElementById('verify-admin-btn').style.display = 'none';
            } else {
                document.getElementById('cancel-admin-btn').style.display = 'none';
                document.getElementById('verify-admin-btn').style.display = 'block';
            }
        }

        function switchPage(pageId) {
document.querySelectorAll('#app-page .page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (pageId !== 'post-detail-page') document.querySelector('body').classList.remove('post-detail-page');
            
            if (pageId === 'home-page' || pageId === 'explore-page') {
                renderAllPosts();
            } else {
                renderCollectionsNav(); 
            }
            
            if (pageId === 'profile-page') renderUserPosts();
        }

        function renderImagePreview() {
            const container = document.getElementById('image-preview');
            container.innerHTML = '';
            selectedImages.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                item.innerHTML = `<img src="${image.src}" data-index="${index}"><button class="remove-image" data-index="${index}">Ã—</button>`;
                container.appendChild(item);
            });
            document.querySelectorAll('.remove-image').forEach(btn => {
                btn.onclick = function() { selectedImages.splice(this.dataset.index, 1); renderImagePreview(); };
            });
        }

        function publishPost() {
            if (!currentUser) { showNotice('è¯·å…ˆç™»å½•'); return; }
let editor = document.querySelector('.editor-content');
            let content = editor.innerHTML;
            let textOnly = editor.innerText.trim();
            let collection = document.getElementById('collection-input').value.trim();
            
            if (!textOnly && selectedImages.length === 0) return showNotice('è¯·è¾“å…¥å†…å®¹æˆ–æ·»åŠ å›¾ç‰‡');
            try {
                if(editingPostId) {
                    const postIndex = allPosts.findIndex(p => p.id === editingPostId);
                    if(postIndex > -1) {
                        allPosts[postIndex].content = content;
                        allPosts[postIndex].images = selectedImages;
                        allPosts[postIndex].location = currentLocation;
                        allPosts[postIndex].collection = collection;
                        localStorage.setItem('allPosts', JSON.stringify(allPosts));
                        editingPostId = null;
                        showNotice('å¸–å­å·²æ›´æ–°');
                    }
                } else {
                    const newPost = {
                        id: Date.now(),
                        authorId: currentUser.id,
                        author: currentUser.name,
                        authorUid: currentUser.uid,
                        avatar: currentUser.avatar,
                        isAuthorAdmin: currentUser.isAdmin,
                        content,
                        images: selectedImages,
                        location: currentLocation,
                        collection: collection,
                        time: new Date(),
                        likes: 0, comments: [], favorites: 0,
                        liked: false, isFeatured: false, isPinned: false
                    };
                    if(!Array.isArray(currentUser.posts)) currentUser.posts = [];
                    allPosts.unshift(newPost);
                    currentUser.posts.unshift(newPost.id);
                    localStorage.setItem('allPosts', JSON.stringify(allPosts));
                    
                    // åŒæ­¥åˆ°è´¦å·åˆ—è¡¨
                    syncCurrentUserToAccounts();
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showNotice('å‘å¸ƒæˆåŠŸï¼');
                    updateProfileDisplay();
                }
                
                editor.innerHTML = '';
                selectedImages = [];
                currentLocation = '';
                document.getElementById('collection-input').value = '';
                document.getElementById('location-display').style.display = 'none';
                renderImagePreview();
                refreshCollectionsData();
                switchPage('explore-page');
            } catch (e) {
                console.error("Publish Error:", e);
                if (e.name === 'QuotaExceededError') alert('å‘å¸ƒå¤±è´¥ï¼šå­˜å‚¨ç©ºé—´å·²æ»¡ã€‚è¯·å°è¯•å‡å°‘å›¾ç‰‡æ•°é‡æˆ–å¯¼å‡ºæ•°æ®åæ¸…ç†ç¼“å­˜ã€‚');
                else alert('å‘å¸ƒé‡åˆ°é—®é¢˜ï¼Œè¯·é‡è¯•ã€‚');
            }
        }
        
        function saveDraft() {
            const content = document.querySelector('.editor-content').innerHTML;
            const collection = document.getElementById('collection-input').value.trim();
            
            if(!content && selectedImages.length === 0) return showNotice('è‰ç¨¿ä¸ºç©º');
            const draft = { id: Date.now(), content, images: selectedImages, location: currentLocation, collection, time: new Date() };
            try {
                drafts.push(draft);
                localStorage.setItem('drafts', JSON.stringify(drafts));
                showNotice('è‰ç¨¿å·²ä¿å­˜');
            } catch (e) { showNotice('ä¿å­˜å¤±è´¥ï¼šç©ºé—´ä¸è¶³'); }
        }

        window.resumeDraft = function(id) {
            const draft = drafts.find(d => d.id === id);
            if (!draft) return;
            selectedImages = JSON.parse(JSON.stringify(draft.images));
            currentLocation = draft.location || '';
            document.querySelector('.editor-content').innerHTML = draft.content;
            document.getElementById('collection-input').value = draft.collection || '';
            
            if(currentLocation) {
                document.getElementById('location-display').style.display = 'block';
                document.getElementById('location-text').innerHTML = '<i class="fas fa-map-marker-alt"></i> ' + currentLocation;
            }
            renderImagePreview();
            switchPage('publish-page');
            showNotice('è‰ç¨¿å·²æ¢å¤');
        };

        window.deleteDraft = function(id) {
            if (!confirm('ç¡®è®¤åˆ é™¤è‰ç¨¿å—ï¼Ÿ')) return;
            drafts = drafts.filter(d => d.id !== id);
            localStorage.setItem('drafts', JSON.stringify(drafts));
            renderDrafts();
            showNotice('è‰ç¨¿å·²åˆ é™¤');
        };

        function renderAllPosts() {
            refreshCollectionsData();
            renderCollectionsNav();
            
            renderPinnedPosts();
            renderFeaturedPosts();
            renderExplorePosts();
        }

        function renderPinnedPosts() {
            const container = document.getElementById('pinned-posts');
            container.innerHTML = '';
            // ç½®é¡¶å¸–é€šå¸¸ä¸å‚ä¸æœç´¢è¿‡æ»¤ï¼Œé™¤ééœ€æ±‚ç‰¹æ®Šï¼Œè¿™é‡Œä¿æŒåŸæ ·
            allPosts.filter(p => p.isPinned).forEach(p => container.appendChild(createPostElement(p)));
        }

        function renderFeaturedPosts() {
            const container = document.getElementById('featured-posts');
            container.innerHTML = '';
            allPosts.filter(p => p.isFeatured && !p.isPinned).forEach(p => container.appendChild(createPostElement(p)));
        }

        // === ä¿®æ”¹ï¼šå‘ç°é¡µæ¸²æŸ“å¢åŠ æœç´¢è¿‡æ»¤ ===
        function renderExplorePosts() {
            const container = document.getElementById('explore-posts');
            container.innerHTML = '';
            
            // åŸºç¡€ç­›é€‰ï¼šéç½®é¡¶
            let posts = allPosts.filter(p => !p.isPinned);

            // åˆé›†ç­›é€‰
            if (currentCollectionFilter !== 'all') {
                posts = posts.filter(p => p.collection === currentCollectionFilter);
            }
            
            // æœç´¢ç­›é€‰
            if (currentSearchTerm) {
                posts = posts.filter(p => {
                    const contentMatch = p.content.toLowerCase().includes(currentSearchTerm);
                    const authorMatch = p.author.toLowerCase().includes(currentSearchTerm);
                    return contentMatch || authorMatch;
                });
            }

            if(posts.length === 0) {
                let emptyMsg = 'è¿˜æ²¡æœ‰å¸–å­';
                if(currentSearchTerm) emptyMsg = `æœªæ‰¾åˆ° "${currentSearchTerm}" ç›¸å…³å†…å®¹`;
                else if(currentCollectionFilter !== 'all') emptyMsg = `åˆé›† "${currentCollectionFilter}" ä¸ºç©º`;
                
                container.innerHTML = `<div class="empty-state"><i class="fas fa-newspaper"></i><p>${emptyMsg}</p></div>`;
                return;
            }
            posts.forEach(p => container.appendChild(createPostElement(p)));
        }
        // === ç»“æŸ ===

        function renderUserPosts() {
            const container = document.getElementById('user-posts');
            container.innerHTML = '';
            if(!currentUser.posts.length) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-newspaper"></i><p>ä½ è¿˜æ²¡æœ‰å¸–å­</p></div>';
                return;
            }
            allPosts.filter(p => currentUser.posts.includes(p.id)).forEach(p => container.appendChild(createPostElement(p)));
        }

        function renderDrafts() {
            const container = document.getElementById('drafts-container');
            container.innerHTML = '';
            if (drafts.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-file"></i><p>è¿˜æ²¡æœ‰è‰ç¨¿</p></div>';
                return;
            }
            drafts.forEach(draft => {
                const draftEl = document.createElement('div');
                draftEl.className = 'draft-item';
                draftEl.innerHTML = `
                    <div style="flex-grow:1;">
                        <div style="font-size:12px; color:var(--gray-medium);">${new Date(draft.time).toLocaleString()}</div>
                        <div style="margin-top:5px; max-height:50px; overflow:hidden;">${draft.content.substring(0, 100)}...</div>
                    </div>
                    <div class="draft-actions">
                        <button class="draft-resume" onclick="resumeDraft(${draft.id})">æ¢å¤</button>
                        <button class="draft-delete" onclick="deleteDraft(${draft.id})">åˆ é™¤</button>
                    </div>`;
                container.appendChild(draftEl);
            });
        }
        function renderFavorites() {
            const container = document.getElementById('favorites-container');
            container.innerHTML = '';
            if(!currentUser.favorites.length) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-bookmark"></i><p>æ”¶è—å¤¹ä¸ºç©º</p></div>';
                return;
            }
            allPosts.filter(p => currentUser.favorites.includes(p.id)).forEach(p => container.appendChild(createPostElement(p)));
        }

        function createPostElement(post) {
            const postEl = document.createElement('div');
            postEl.className = `post ${post.isAnnouncement ? 'announcement' : ''} ${post.isPinned ? 'pinned' : ''}`;
            const timeStr = new Date(post.time).toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
            const uidHtml = showUid ? `<div class="post-uid">UID: ${post.authorUid}</div>` : '';
            const locHtml = post.location ? `<div class="post-location"><i class="fas fa-map-marker-alt"></i> ${post.location}</div>` : '';
            
            const collectionHtml = post.collection 
                ? `<div class="post-collection-tag" onclick="filterByCollection('${post.collection}'); event.stopPropagation();"><i class="fas fa-layer-group"></i> ${post.collection}</div>` 
                : '';

            const isSpecialUser = post.author === 'è¯…éª¨';
            const specialClass = isSpecialUser ? 'special-avatar' : '';
            const avatarSrc = isSpecialUser ? "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" : (post.avatar || '');

            let html = `
                <div class="post-header">
                    <img src="${avatarSrc}" class="post-avatar ${specialClass}" data-author="${post.author}">
                    <div class="post-meta">
                        <div class="post-author">${post.author} ${post.isAuthorAdmin?'<span class="admin-badge">ç®¡ç†å‘˜</span>':''}</div>
                        <div class="post-time">${timeStr}</div>
                        ${uidHtml}
                    </div>
                </div>
                <div class="post-content">${post.content}</div>`;

            if (post.images && post.images.length > 0) {
                const layout = post.images[0].layout || 'auto';
                let cssClass = 'multiple';
                if (layout.startsWith('single') || post.images.length === 1) cssClass = 'single';
                else if (post.images.length === 2) cssClass = 'double';
                else if (post.images.length === 3) cssClass = 'triple';

                html += `<div class="post-images ${cssClass}">`;
                post.images.forEach((img, idx) => {
                    const sizeClass = (layout === 'single-large' || cssClass === 'single') ? 'large' : 'small';
                    html += `<img src="${img.src}" class="post-image ${sizeClass}" onclick="openImageViewer([${post.images.map(i => `'${i.src}'`).join(',')}], ${idx})">`;
                });
                html += `</div>`;
            }
            
            html += `<div class="post-footer-content">
                        ${collectionHtml} 
                        ${locHtml}
                     </div>`;
html += `
                <div class="post-actions">
                    <div class="post-action ${post.liked?'active':''}" onclick="toggleLike(${post.id})">
                        <i class="${post.liked?'fas':'far'} fa-heart"></i> <span>${post.likes}</span>
                    </div>
                    <div class="post-action" onclick="viewPostDetail(${post.id})">
                        <i class="far fa-comment"></i> <span>${post.comments.length}</span>
                    </div>
                    <div class="post-action ${post.favorited?'active':''}" onclick="toggleFavorite(${post.id})">
                        <i class="${post.favorited?'fas':'far'} fa-bookmark"></i>
                    </div>
                    <div class="post-action" onclick="sharePostToChat(${post.id})">
                        <i class="fas fa-share-alt"></i>
                    </div>
                </div>`;
            if (currentUser && currentUser.posts.includes(post.id)) {
                html += `<div class="post-admin-actions">
                    <button class="admin-btn" onclick="editPost(${post.id})"><i class="fas fa-edit"></i> ç¼–è¾‘</button>
                    <button class="admin-btn delete" onclick="deletePost(${post.id})"><i class="fas fa-trash"></i> åˆ é™¤</button>
                </div>`;
            }
            postEl.innerHTML = html;
            return postEl;
        }

        window.sharePostToChat = function(postId) {
            if (!mqttClient || !currentRoom) { showNotice('è¯·å…ˆåŠ å…¥ä¸€ä¸ªèŠå¤©å®¤'); switchPage('chat-page'); return; }
            const post = allPosts.find(p => p.id === postId);
            if (!post) return;
            
            let shareContent = `ã€åˆ†äº«å¸–å­ã€‘\nä½œè€…: ${post.author}\n`;
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = post.content;
            let text = tempDiv.textContent || tempDiv.innerText || "";
            if (text.length > 50) text = text.substring(0, 50) + "...";
            shareContent += `å†…å®¹: ${text}`;
            if (post.images.length > 0) shareContent += `\n[å›¾ç‰‡ x${post.images.length}]`;
            
            const msg = { sender: currentUser.name, uid: currentUser.uid, avatar: currentUser.avatar, content: shareContent, time: new Date() };
            mqttClient.publish(`dream/chat/${currentRoom}`, JSON.stringify(msg));
            addChatMessage(msg, 'outgoing');
            showNotice('å·²åˆ†äº«åˆ°èŠå¤©å®¤');
            switchPage('chat-page');
        };

        window.toggleLike = function(id) {
            const post = allPosts.find(p => p.id === id);
            if(!post) return;
            post.liked = !post.liked;
            post.likes += post.liked ? 1 : -1;
            localStorage.setItem('allPosts', JSON.stringify(allPosts));
            renderAllPosts();
        };

        window.toggleFavorite = function(id) {
            const post = allPosts.find(p => p.id === id);
            if(!post) return;
            post.favorited = !post.favorited;
            post.favorites += post.favorited ? 1 : -1;
            if(post.favorited && !currentUser.favorites.includes(id)) currentUser.favorites.push(id);
            else if(!post.favorited) currentUser.favorites = currentUser.favorites.filter(fid => fid !== id);
            localStorage.setItem('allPosts', JSON.stringify(allPosts));
            // åŒæ­¥
            syncCurrentUserToAccounts();
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            renderAllPosts();
        };

        window.editPost = function(id) {
            const post = allPosts.find(p => p.id === id);
            if(!post) return;
            editingPostId = id;
            selectedImages = JSON.parse(JSON.stringify(post.images));
            currentLocation = post.location || '';
            document.querySelector('.editor-content').innerHTML = post.content;
            document.getElementById('collection-input').value = post.collection || '';
            if(currentLocation) {
                document.getElementById('location-display').style.display = 'block';
                document.getElementById('location-text').innerHTML = '<i class="fas fa-map-marker-alt"></i> ' + currentLocation;
            }
            renderImagePreview();
            switchPage('publish-page');
            document.querySelector('.editor-content').focus();
            showNotice('æ­£åœ¨ç¼–è¾‘å¸–å­...');
        };

        window.deletePost = function(id) {
            if(!confirm("ç¡®è®¤åˆ é™¤è¿™æ¡å¸–å­å—ï¼Ÿ")) return;
            const btn = document.querySelector(`.admin-btn.delete[onclick="deletePost(${id})"]`);
            if(btn) {
const postCard = btn.closest('.post');
                if(postCard) {
                    postCard.style.transition = "all 0.3s ease";
                    postCard.style.opacity = "0";
                    postCard.style.transform = "scale(0.9)";
                    setTimeout(() => postCard.remove(), 300); 
                }
            }
            allPosts = allPosts.filter(p => p.id !== id);
            localStorage.setItem('allPosts', JSON.stringify(allPosts));
            
            if(currentUser) {
                currentUser.posts = currentUser.posts.filter(pid => pid !== id);
                currentUser.favorites = currentUser.favorites.filter(fid => fid !== id);
                // åŒæ­¥
                syncCurrentUserToAccounts();
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }

            showNotice('å¸–å­å·²åˆ é™¤');
            refreshCollectionsData();
            setTimeout(() => {
                updateProfileDisplay();
                if (!document.body.classList.contains('post-detail-page')) {
                     if(!btn) renderAllPosts(); 
                } else {
                    switchPage('explore-page');
                }
            }, 300);
        };

        window.viewPostDetail = function(id) {
            currentPost = allPosts.find(p => p.id === id);
            if(!currentPost) return;
            document.getElementById('post-detail').innerHTML = '';
            document.getElementById('post-detail').appendChild(createPostElement(currentPost));
            document.getElementById('post-detail').classList.add('no-border');
            renderComments();
            switchPage('post-detail-page');
            document.querySelector('body').classList.add('post-detail-page');
        };

        function renderComments() {
            const container = document.getElementById('comments-section');
            container.innerHTML = '';
            if (!currentPost.comments || currentPost.comments.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><p>æš‚æ— è¯„è®º</p></div>';
            } else {
                currentPost.comments.forEach(comment => container.appendChild(createCommentElement(comment)));
            }
        }

        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'comment';
            div.dataset.commentId = comment.id;
            
            let pressTimer;
            const startPress = () => { pressTimer = setTimeout(() => {
                if (currentUser.isAdmin || comment.authorId === currentUser.id) {
                     if(confirm('åˆ é™¤è¿™æ¡è¯„è®º?')) deleteComment(currentPost.id, comment.id);
                }
            }, 800); };
            const endPress = () => clearTimeout(pressTimer);
            div.addEventListener('touchstart', startPress);
            div.addEventListener('touchend', endPress);
            div.addEventListener('mousedown', startPress);
            div.addEventListener('mouseup', endPress);
            
            const isLiked = comment.likes && comment.likes.includes(currentUser.uid);
            const likeCount = comment.likes ? comment.likes.length : 0;
            
            div.innerHTML = `
                <div class="comment-header">
                    <img src="${comment.avatar||''}" class="comment-avatar">
                    <div class="comment-author">${comment.author}</div>
                    <div class="comment-time">${new Date(comment.time).toLocaleTimeString()}</div>
                </div>
                <div class="comment-content">${comment.content}</div>
                <div class="comment-actions" style="margin-top:8px; display:flex; gap:15px; font-size:12px; color:var(--gray-medium);">
                    <span class="comment-action" onclick="toggleReply(${comment.id})" style="cursor:pointer;">å›å¤</span>
                    <span class="comment-action ${isLiked?'active':''}" onclick="likeComment(${currentPost.id}, ${comment.id})" style="cursor:pointer; color:${isLiked?'var(--primary-color)':''}">
                        <i class="${isLiked?'fas':'far'} fa-heart"></i> ${likeCount || ''}
                    </span>
                </div>
                <div class="reply-form" id="reply-form-${comment.id}" style="display:none; margin-top:10px; gap:5px;">
                    <input type="text" id="reply-input-${comment.id}" placeholder="å›å¤..." style="font-size:12px; padding:8px;">
                    <button class="btn" onclick="addReply(${comment.id})" style="padding:6px 12px;border-radius:20px;font-size:12px;">å‘é€</button>
                </div>
            `;
            if (comment.replies) {
                comment.replies.forEach(rep => {
                    const repDiv = document.createElement('div');
                    repDiv.style.cssText = 'margin-left:10px; border-left:2px solid var(--border-color); padding-left:10px; margin-top:8px;';
                    repDiv.innerHTML = `<div style="font-size:11px;"><span style="font-weight:bold">${rep.author}</span> <span style="color:gray">${new Date(rep.time).toLocaleTimeString()}</span></div><div style="font-size:13px; margin-top:3px;">${rep.content}</div>`;
                    div.appendChild(repDiv);
                });
            }
            return div;
        }

        window.deleteComment = function(postId, commentId) {
            const post = allPosts.find(p => p.id === postId);
            if (post) {
                post.comments = post.comments.filter(c => c.id !== commentId);
                localStorage.setItem('allPosts', JSON.stringify(allPosts));
                if (currentPost && currentPost.id === postId) renderComments();
                showNotice("è¯„è®ºå·²åˆ é™¤");
            }
        };

        window.toggleReply = function(id) {
            const form = document.getElementById(`reply-form-${id}`);
            form.style.display = form.style.display === 'flex' ? 'none' : 'flex';
        };

        window.likeComment = function(postId, commentId) {
            const post = allPosts.find(p => p.id === postId);
            const comment = post.comments.find(c => c.id === commentId);
            if (!comment.likes) comment.likes = [];
            const idx = comment.likes.indexOf(currentUser.uid);
            if (idx === -1) comment.likes.push(currentUser.uid);
            else comment.likes.splice(idx, 1);
            localStorage.setItem('allPosts', JSON.stringify(allPosts));
            renderComments();
        };
window.addComment = function() {
            const input = document.getElementById('comment-input');
            if(!input.value.trim()) return;
            const newComment = {
                id: Date.now(),
                authorId: currentUser.id,
                author: currentUser.name,
                avatar: currentUser.avatar,
                content: input.value,
                time: new Date(),
                replies: [], likes: []
            };
            currentPost.comments.push(newComment);
            localStorage.setItem('allPosts', JSON.stringify(allPosts));
            input.value = '';
            renderComments();
        };

        window.addReply = function(commentId) {
            const input = document.getElementById(`reply-input-${commentId}`);
            if(!input.value.trim()) return;
            const comment = currentPost.comments.find(c => c.id === commentId);
            if(!comment.replies) comment.replies = [];
            comment.replies.push({ id: Date.now(), author: currentUser.name, authorId: currentUser.id, content: input.value, time: new Date() });
            localStorage.setItem('allPosts', JSON.stringify(allPosts));
            renderComments();
        };

        window.openImageViewer = function(images, index) {
            currentViewingImages = images;
            currentImageIndex = index;
            document.getElementById('image-viewer-img').src = images[index];
            document.getElementById('image-viewer').style.display = 'flex';
        };

        function closeImageViewer() { document.getElementById('image-viewer').style.display = 'none'; }
        window.showNextImage = function() {
            currentImageIndex = (currentImageIndex + 1) % currentViewingImages.length;
            document.getElementById('image-viewer-img').src = currentViewingImages[currentImageIndex];
        };
        window.showPrevImage = function() {
            currentImageIndex = (currentImageIndex - 1 + currentViewingImages.length) % currentViewingImages.length;
            document.getElementById('image-viewer-img').src = currentViewingImages[currentImageIndex];
        };

        function joinChatRoom() {
            const roomId = document.getElementById('room-id').value.trim();
            if (!roomId) return showNotice('è¯·è¾“å…¥æˆ¿é—´å·');
            if (mqttClient) mqttClient.end();
            document.getElementById('room-status').textContent = 'è¿æ¥ä¸­...';
            const clientId = 'dream_' + Math.random().toString(16).substr(2, 8);
            mqttClient = mqtt.connect('wss://test.mosquitto.org:8081/mqtt', { clientId, keepalive: 60 });
            
            mqttClient.on('connect', () => {
                document.getElementById('room-status').textContent = `æˆ¿é—´: ${roomId}`;
                document.getElementById('join-room').parentElement.style.display = 'none';
                document.getElementById('leave-room').style.display = 'block';
                document.getElementById('message-input').disabled = false;
                document.getElementById('send-message').disabled = false;
                currentRoom = roomId;
                mqttClient.subscribe(`dream/chat/${roomId}`);
                mqttClient.subscribe(`dream/presence/${roomId}`);
                addSystemMessage(`å·²åŠ å…¥æˆ¿é—´ ${roomId}`);
                lastHeartbeats = {};
                startHeartbeat();
            });
            
            mqttClient.on('message', (topic, message) => {
                const topicStr = topic.toString();
                const msgStr = message.toString();
                if (topicStr.includes('presence')) {
try {
                        let presenceData; // Simplified error handling for presence
                        try { presenceData = JSON.parse(msgStr); } catch(e) { presenceData = { uid: msgStr, status: 'heartbeat' }; }
                        if (presenceData.status === 'leave') delete lastHeartbeats[presenceData.uid];
                        else lastHeartbeats[presenceData.uid] = Date.now();
                        updateOnlineCount();
                    } catch(e) {}
                } else {
                    try {
                        const msg = JSON.parse(msgStr);
                        if (msg.uid !== currentUser.uid) {
                            addChatMessage(msg, 'incoming');
                        }
                    } catch(e){}
                }
            });
            mqttClient.on('error', (err) => { document.getElementById('room-status').textContent = 'è¿æ¥é”™è¯¯'; });
        }
        function updateOnlineCount() {
            const now = Date.now();
            let count = 0;
            for (let uid in lastHeartbeats) {
                if (now - lastHeartbeats[uid] < 15000) count++;
                else delete lastHeartbeats[uid];
            }
            if (count === 0) count = 1;
            document.getElementById('online-count').textContent = `åœ¨çº¿: ${count}äºº`;
        }
        
        function startHeartbeat() {
            if (presenceInterval) clearInterval(presenceInterval);
            const sendHeartbeat = () => {
                if (mqttClient && currentRoom) {
                    const presenceMsg = JSON.stringify({ uid: currentUser.uid, status: 'heartbeat' });
                    mqttClient.publish(`dream/presence/${currentRoom}`, presenceMsg);
                }
            };
            sendHeartbeat();
            presenceInterval = setInterval(() => {
                sendHeartbeat();
                updateOnlineCount();
            }, 5000);
        }

        function leaveChatRoom() {
            if(!confirm("ç¡®å®šè¦ç¦»å¼€æˆ¿é—´å—ï¼Ÿ")) return;
            if (presenceInterval) { clearInterval(presenceInterval); presenceInterval = null; }
            if (mqttClient && currentRoom) { 
                const presenceMsg = JSON.stringify({ uid: currentUser.uid, status: 'leave' });
                mqttClient.publish(`dream/presence/${currentRoom}`, presenceMsg);
                setTimeout(() => { mqttClient.end(); mqttClient = null; }, 200);
            } else {
                if(mqttClient) mqttClient.end();
                mqttClient = null;
            }
            document.getElementById('room-status').textContent = 'æœªè¿æ¥';
            document.getElementById('online-count').textContent = '';
            document.getElementById('join-room').parentElement.style.display = 'flex';
            document.getElementById('leave-room').style.display = 'none';
            document.getElementById('message-input').disabled = true;
            document.getElementById('send-message').disabled = true;
            currentRoom = null;
        }
        
        function sendChatMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            if (!content || !mqttClient || !currentRoom) return;
            const msg = { sender: currentUser.name, uid: currentUser.uid, avatar: currentUser.avatar, content, time: new Date(), quote: currentQuote };
            // ä¿é™©èµ·è§å‘å¸ƒ
            try {
                mqttClient.publish(`dream/chat/${currentRoom}`, JSON.stringify(msg));
                addChatMessage(msg, 'outgoing');
                input.value = '';
                cancelQuote();
            } catch (e) { showNotice('è¿æ¥æ–­å¼€'); }
        }

        function sendChatImage(base64) {
             if (!mqttClient || !currentRoom) return showNotice("è¯·å…ˆè¿›å…¥æˆ¿é—´");
             const msg = { sender: currentUser.name, uid: currentUser.uid, avatar: currentUser.avatar, content: "[å›¾ç‰‡]", image: base64, time: new Date(), quote: currentQuote };
             try {
                mqttClient.publish(`dream/chat/${currentRoom}`, JSON.stringify(msg));
                addChatMessage(msg, 'outgoing');
                cancelQuote();
             } catch(e) { showNotice("å›¾ç‰‡å‘é€å¤±è´¥ï¼Œå¯èƒ½è¿‡å¤§"); }
        }
        
        function setQuote(author, content) {
            currentQuote = { author, content };
            const preview = document.getElementById('chat-quote-preview');
            const textEl = document.getElementById('quote-text-preview');
            preview.style.display = 'flex';
            let displayContent = content;
            if (content.startsWith('[å›¾ç‰‡]')) displayContent = '[å›¾ç‰‡]';
            else if (content.length > 20) displayContent = content.substring(0, 20) + '...';
            textEl.textContent = `å›å¤ ${author}: ${displayContent}`;
            document.getElementById('message-input').focus();
        }
        
        function cancelQuote() {
            currentQuote = null;
            document.getElementById('chat-quote-preview').style.display = 'none';
        }

        function addChatMessage(msgObj, type) {
            const sender = msgObj.sender;
            const text = msgObj.content;
            const avatar = msgObj.avatar;
            const imgData = msgObj.image;
            const quote = msgObj.quote;
            const div = document.createElement('div');
            div.className = `message ${type}`;
            let contentHtml = '';
            if (quote) {
                let qContent = quote.content;
                if(qContent.length > 30 && !qContent.startsWith('[å›¾ç‰‡]')) qContent = qContent.substring(0, 30) + '...';
                contentHtml += `<div class="message-quote">å›å¤ ${quote.author}: ${qContent}</div>`;
            }
            contentHtml += `<div class="message-sender">${sender}</div>`;
            if (imgData) {
                contentHtml += `<img src="${imgData}" class="message-img" onclick="openImageViewer(['${imgData}'], 0)">`;
            } else {
                contentHtml += `<div class="message-text">${text}</div>`;
            }
            div.innerHTML = `<img src="${avatar||''}" class="message-avatar"> <div class="message-content">${contentHtml}</div>`;
            const showContext = (e) => {
                e.preventDefault();
                const menu = document.getElementById('message-context-menu');
                const quoteBtn = document.getElementById('quote-msg-btn');
                quoteBtn.dataset.author = sender;
                quoteBtn.dataset.content = imgData ? '[å›¾ç‰‡]' : text;
                let x = e.clientX || e.touches[0].clientX;
                let y = e.clientY || e.touches[0].clientY;
                if (x + 100 > window.innerWidth) x = window.innerWidth - 100;
                menu.style.left = x + 'px';
                menu.style.top = y + 'px';
                menu.style.display = 'block';
            };
            div.addEventListener('contextmenu', showContext);
            let touchTimer;
            div.addEventListener('touchstart', (e) => { touchTimer = setTimeout(() => showContext(e), 600); });
            div.addEventListener('touchend', () => clearTimeout(touchTimer));
            const container = document.getElementById('chat-messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'system-message';
            div.style.cssText = "text-align:center;font-size:12px;color:var(--gray-medium);margin:8px 0;";
            div.textContent = text;
            document.getElementById('chat-messages').appendChild(div);
        }

        function verifyAdmin() {
            if (document.getElementById('admin-code').value === ADMIN_CODE) {
                currentUser.isAdmin = true;
localStorage.setItem('currentUser', JSON.stringify(currentUser));
                syncCurrentUserToAccounts();
                showNotice('å·²è·å¾—ç®¡ç†å‘˜æƒé™');
                updateProfileDisplay();
                document.getElementById('admin-modal').style.display = 'none';
            } else showNotice('ç®¡ç†ç é”™è¯¯');
        }

        function cancelAdmin() {
            if (confirm('ç¡®å®šè¦å–æ¶ˆç®¡ç†å‘˜æƒé™å—ï¼Ÿ')) {
                currentUser.isAdmin = false;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                syncCurrentUserToAccounts();
                showNotice('å·²å–æ¶ˆç®¡ç†å‘˜æƒé™');
                updateProfileDisplay();
                document.getElementById('admin-modal').style.display = 'none';
            }
        }

        function toggleEditProfile() {
            const form = document.getElementById('edit-profile-form');
            form.style.display = form.style.display === 'none' ? 'grid' : 'none';
        }

        function saveProfile() {
            currentUser.name = document.getElementById('profile-name-input').value;
            currentUser.bio = document.getElementById('profile-bio-input').value;
            if (document.getElementById('avatar-preview').src) currentUser.avatar = document.getElementById('avatar-preview').src;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            syncCurrentUserToAccounts(); // profile æ›´æ–°ä¹Ÿè¦åŒæ­¥åˆ°åˆ—è¡¨
            updateProfileDisplay();
            toggleEditProfile();
            showNotice('èµ„æ–™å·²æ›´æ–°');
        }

        function saveSettings() {
            const customCss = document.getElementById('custom-css-input').value;
            localStorage.setItem('userCustomCSS', customCss);
            applyCustomCSS(customCss);
            showNotice('è®¾ç½®ä¸è‡ªå®šä¹‰æ ·å¼å·²ä¿å­˜'); 
        }
        function logout() { 
            if(confirm('é€€å‡ºç™»å½•?')) { 
                localStorage.removeItem('currentUser'); 
                location.reload(); 
            } 
        }
    </script>
</body>
</html>
